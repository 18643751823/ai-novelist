# Chapter 组件模块文档

本章节组件负责管理小说项目的文件树结构，包括章节文件、文件夹的显示、操作和管理功能。

## 文件结构

```
chapter/
├── ChapterTreePanel.js      # 章节树主面板组件
├── ChapterTreeRenderer.js   # 章节树渲染模块
├── CheckpointPanel.js       # 版本历史面板
├── ContextMenuManager.js    # 右键菜单管理模块
├── FileOperations.js        # 文件操作模块
├── PrefixEditManager.js     # 前缀编辑管理模块
├── SettingsManager.js       # 设置管理模块
├── ChapterTreePanel.css     # 章节树样式文件
└── CheckpointPanel.css      # 版本历史面板样式文件
```

## 各文件详细说明

### 1. ChapterTreePanel.js
**主要功能**: 章节树的主面板组件，整合所有子模块功能

**核心职责**:
- 管理章节树的整体状态和显示
- 协调各个子模块之间的交互
- 处理章节点击、展开/折叠等用户交互
- 管理模态框（重命名、通知、确认等）

**主要特性**:
- 支持文件/文件夹的树形结构显示
- 提供新建文件/文件夹、刷新、版本历史等操作按钮
- 集成右键菜单功能
- 支持前缀编辑功能
- 管理设置面板

**依赖关系**:
- 使用 Redux 管理状态
- 集成所有子模块（ContextMenuManager、FileOperations、PrefixEditManager、SettingsManager）
- 通过 IPC 与后端通信

### 2. ChapterTreeRenderer.js
**主要功能**: 递归渲染章节树结构

**核心职责**:
- 递归渲染文件和文件夹的树形结构
- 处理每个节点的显示逻辑
- 管理节点的展开/折叠状态
- 渲染前缀编辑界面

**主要特性**:
- 支持无限层级嵌套
- 自动处理缩进和层级显示
- 集成前缀编辑功能
- 支持右键菜单触发

**设计模式**:
- 使用递归组件模式渲染树形结构
- 通过 props 传递渲染函数实现模块化

### 3. CheckpointPanel.js
**主要功能**: 版本历史管理面板

**核心职责**:
- 显示和管理所有存档版本
- 处理存档的创建、恢复和删除
- 提供版本回滚功能

**主要特性**:
- 显示存档时间、描述信息
- 支持创建新存档
- 支持恢复到指定版本
- 支持删除存档
- 提供确认机制防止误操作

**安全机制**:
- 恢复操作前显示确认提示
- 删除操作需要二次确认

### 4. ContextMenuManager.js
**主要功能**: 右键菜单管理模块

**核心职责**:
- 根据点击位置动态构建菜单项
- 管理右键菜单的显示和隐藏
- 处理菜单项点击事件

**主要特性**:
- 智能菜单项生成（根据点击对象类型）
- 支持文件和文件夹的不同菜单项
- 集成复制/剪切/粘贴功能
- 支持新建文件和文件夹

**菜单项逻辑**:
- 点击文件：复制、剪切、重命名、删除
- 点击文件夹：复制、剪切、重命名、删除、粘贴、新建文件、新建文件夹
- 点击空白处：新建文件、新建文件夹、粘贴

### 5. FileOperations.js
**主要功能**: 文件操作核心模块

**核心职责**:
- 处理所有文件系统操作
- 管理复制/剪切/粘贴状态
- 提供文件操作确认机制

**支持的操作**:
- 新建文件/文件夹
- 重命名文件/文件夹
- 删除文件/文件夹
- 复制/剪切/粘贴
- 移动文件/文件夹

**核心特性**:
- 统一的 IPC 操作处理
- 自动处理文件扩展名
- 提供操作确认机制
- 支持批量操作状态管理

**安全机制**:
- 删除操作需要确认
- 重命名时自动保留文件扩展名
- 操作失败时显示错误提示

### 6. PrefixEditManager.js
**主要功能**: 前缀编辑管理模块

**核心职责**:
- 管理文件/文件夹的前缀编辑功能
- 处理排序顺序的更新
- 提供前缀编辑界面

**主要特性**:
- 点击前缀进入编辑模式
- 支持数字前缀输入
- 实时验证输入有效性
- 支持 Enter 确认、Escape 取消
- 自动更新排序顺序

**排序逻辑**:
- 通过数字前缀控制显示顺序
- 支持在同一目录内重新排序
- 通过 IPC 更新后端排序配置

### 7. SettingsManager.js
**主要功能**: 暂无

## 模块间协作关系

```
ChapterTreePanel (主控制器)
    ├── ChapterTreeRenderer (视图渲染)
    ├── ContextMenuManager (右键菜单)
    ├── FileOperations (文件操作)
    ├── PrefixEditManager (前缀编辑)
    └── SettingsManager (设置管理)
```

## 数据流

1. **初始化**: ChapterTreePanel 通过 IPC 获取章节数据
2. **渲染**: ChapterTreeRenderer 递归渲染树形结构
3. **交互**: 用户操作通过各个管理器模块处理
4. **更新**: 操作结果通过 IPC 同步到后端，然后刷新前端显示

## IPC 通信

所有文件操作都通过对应的 IPC Handler 与后端通信：
- `chapterIpcHandler`: 章节相关操作
- `fileOperationsIpcHandler`: 文件操作
- `checkpointIpcHandler`: 版本历史操作

## 状态管理

使用 Redux 管理全局状态：
- `novelSlice`: 管理章节数据、刷新计数器、当前任务ID等
- 本地状态：管理 UI 状态（展开/折叠、编辑状态等）

## 样式文件

- `ChapterTreePanel.css`: 章节树主面板样式
- `CheckpointPanel.css`: 版本历史面板样式

这个组件模块提供了完整的小说文件管理功能，支持复杂的文件树操作和版本控制。